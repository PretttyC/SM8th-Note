# 视频流和内容分发网

## 视频

* 流式视频（Streaming Video）  
通过互联网将视频内容分割为多个小数据块，并采用边传输边播放的技术，用户无需等待整个文件下载完成即可实时观看视频。其核心原理是分段传输与实时解码，与传统下载后播放的方式有本质区别。

* 视频帧  
静态图像（单张画面），视觉信息的最小单位  

* 帧率（Frame Rate）  
视频是一系列的图像，通常以恒定的速率来展现，一幅图为一帧，每秒显示的帧数称为帧率，单位为FPS（Frames Per Second）。  
帧数决定视频**流畅度**(运动连贯性)。  

* 色彩深度  
每个像素的颜色位数（如8位、10位）  
 
* 比特率（Bit Rate）  
比特率，又称码率或二进制位速率，指单位时间内传输或处理的二进制比特（bit）数量，单位为比特每秒（bps）。  
比特率决定视频**清晰度**和文件大小。  
如今的视频压缩算法能够将一个视频压缩成任意比特率。  

* 比特率的计算  
比特率（bps） = 文件总数据量（比特） ÷ 视频时长（秒）  
比特率（bps） = 分辨率（总像素数） × 色彩深度（bit） × 帧率（fps）  
分辨率：宽度像素 × 高度像素（如1920×1080）  

对流式视频最重要的性能指标是端到端的平均吞吐量。为了提供连续不断的播放，网络平均吞吐量必须大于等于压缩视频的比特率。  

## 音频

声音的三要素：  

| 要素 | 物理量      | 感知属性 |
|----|----------|------|
| 音调 | 频率（Hz）   | 音高   |
| 响度 | 振幅（dB）   | 音量   |
| 音色 | 谐波频谱(波形) | 音质   |

* 流式音频  
通过将完整音频文件切割为多个小片段，按需动态传输。  
 
* 声音的采样  
采样以固定时间间隔（如44.1 kHz即每1/44100秒）记录声波的振幅值，形成离散的时间点序列。  
**音调的还原**：每个采样点记录了特定时刻声波的振幅，而连续的采样点序列通过波形重建（如插值算法）还原原始声波的频率特征。  
**响度的还原**：振幅值反应声音的响度。  
**音色的还原**：波形即反应声音的音色。

* 采样率  
采样率指采样的频率，即一秒内采样的次数。采样率即是音频的分辨率，采样率越高，越还原真实的声音。  

* 采样点 / 采样(Sample)   
每一次采样的结果即采样点。每个采样点对应声波在特定时刻的瞬时振幅。  
采样点的幅度值本质上是声音振幅在数字系统中的离散化表示。  

* 音频帧(frame)  
音频帧是一组采样点(多声道)的集合，是编码/解码和传输的最小处理单元，包含固定数量的采样点及元数据（如声道数、时间戳）。  
帧时长 = 每帧采样点数 / 采样率  
音频帧的作用：  
  • 编解码的最小处理单元  
  • 音视频同步：帧头的时间戳信息与视频帧对齐，确保播放时声画同步  
  • 网络传输控制：流媒体协议（如RTP）按帧打包发送  
  • 错误恢复机制：帧内添加校验码（如CRC）  

* 包(Packet)  
一个或多个连续帧的集合  

* 音频位深度（Bit Depth）  
  位深度表示每个采样点用多少二进制位（Bit）记录振幅值。例如：  
  • 8位：可表示 256 个振幅等级（2⁸）  
  • 16位（CD标准）：65,536 个等级（2¹⁶）  
  • 24位（专业级）：约 1677 万个等级（2²⁴）

* 声道  
  音频的采集和播放是可以叠加的，因此，可以同时从多个音频源采集声音，并分别输出到不同的扬声器，故声道数一般表示声音录制时的音源数量或回放时相应的扬声器数量。  
  单声道（Mono）和双声道（Stereo）比较常见，顾名思义，前者的声道数为1，后者为2。

* 码率（Bitrate）/ 比特率  
码率表示单位时间内传输或处理的数据量，单位为bps（比特/秒）。

* 码率的计算  
码率 (kbps) = 文件大小 (字节) × 8 / 时间 (秒)×1024  
码率 (kbps) = 采样率 (kHz) × 位深 (bit) × 声道数 × 压缩系数  

## 编码格式和封装格式

编码格式和封装格式是多媒体技术中的两个核心概念，它们在视频文件的存储、传输和播放中扮演不同角色，共同构成完整的视频体验。  

### 封装格式
封装格式又称容器格式，其本质是多媒体文件的“外壳”，负责将已编码的视频流、音频流、字幕、元数据（如分辨率、时长、作者信息）等打包成一个完整的文件。它决定了文件的扩展名（如 .mp4、.mkv），但不直接处理画质或音质。  

常见封装格式：  
• MP4：通用性强，支持H.264/H.265/AV1等编码，适合网络传播和移动设备；  
• MKV：开源且灵活，支持多音轨/字幕轨，适合高清电影；  
• AVI：早期标准，兼容性好但文件体积大，逐渐被取代；  
• WebM：专为网页设计，支持VP9/AV1视频和Opus音频。

### 编码格式

编码格式即压缩算法，负责对原始音视频数据进行压缩（编码）和解压缩（解码），目的是减小文件体积，同时尽量保留质量。  
编码格式直接影响画质清晰度、文件大小及设备解码性能。  

主流编码格式如下：  

视频编码：  
• H.264/AVC：最普及，平衡画质与压缩率，广泛用于流媒体；  
• H.265/HEVC：效率比H.264高50%，支持4K/8K，但需更强算力；  
• AV1：开源免专利费，压缩率优于H.265，逐渐普及（如YouTube）。  

音频编码：  
• AAC：高效有损压缩，取代MP3成为主流；  
• Opus：低延迟，适合实时通信（如视频会议）。  

注意：  
• MP3 具有双重身份：它既是一种音频编码格式，也可作为独立的音频封装格式。  
• MP3 的本质是一种有损音频压缩算法（全称 MPEG-1 Audio Layer 3），属于音频数据的压缩标准。  
• MP3 文件本身也是一种简易的音频容器格式，但功能远不如 MP4、MKV 等通用容器。  
• 类似于MP3这种同时具备编码格式和封装格式双重身份的音视频格式还有WAV(Waveform Audio File Format)、WMA(Windows Media Audio)、FLAC(Free Lossless Audio Codec)。  

## 流媒体协议

### HTTP流式传输(流媒体协议出现之前)
在流媒体协议（如 RTSP、RTMP、HLS 等）正式出现之前，流媒体技术已经存在，但其实现方式依赖于早期的网络技术和变通方案，而非专用协议。  

* 顺序流式传输：媒体文件在服务器分块且按时间顺序存储，用户通过 HTTP/FTP 协议下载媒体文件时，文件按顺序从服务器传输，播放器通过本地缓存实现边下边播(用户需等待初始缓冲)。  
* 在给定时刻，用户只能观看已下载的那部分，而不能跳到还未下载的部分。  
* 在传输期间不能根据用户连接的速度动态调整码率。  

### 早期专有协议阶段（1990s–2000s）
* RTSP/RTP  
• 提出者：RealNetworks（1996年），后由IETF标准化（RFC 2326）。  
• 特点：基于UDP传输，支持双向交互控制（播放、暂停等），但部署复杂且需动态端口协商。采用协议分离架构：RTSP 负责信令控制、RTP 负责数据传输、RTCP 监控网络质量（丢包率、抖动），反馈至发送端动态调整编码策略，实现逻辑与传输解耦。  

• 应用场景：视频监控、点播系统（如IP摄像头）。  
 
* RTMP  
• 提出者：Macromedia（2002年），后被Adobe收购。  
• 特点：基于TCP，延迟低（1–3秒），成为Flash时代直播主流协议。2012年后因Flash淘汰逐渐边缘化。  
 
* MMS  
• 提出者：微软（1999年），私有协议仅支持Windows平台，2012年后停止维护。  

### HTTP标准化时代（2010s）
* HLS  
• 提出者：苹果公司（2009年）。  
• 特点：基于HTTP传输TS分片，支持自适应码率，但原生延迟高达10–30秒。  
• 意义：解决iOS兼容性问题，成为跨平台点播/直播的事实标准。  
 
* MPEG-DASH  
• 提出者：MPEG组织（2012年标准化）。  
• 特点：开放标准，类似HLS但支持更多编码格式（如H.265、AV1）  

### 当前主流协议（2020s至今）
#### 超低延迟协议（<500ms）
* WebRTC  
• 特点：基于UDP/P2P传输，浏览器原生支持，延迟<0.5秒。  
• 应用：视频会议、互动直播（如Google Meet）。  

* SRT  
• 提出者：Haivision（2013年）。  
• 特点：基于UDP，内置AES加密与抗丢包机制，延迟0.1–0.5秒。  
• 应用：广电级直播（如腾讯视频云）、远程制作。  

* RIST  
• 提出者：VideoLAN（2017年）。  
• 特点：自适应拥塞控制，支持多路径传输，延迟0.2–1秒。  
• 优势：更适合公共互联网不稳定环境。  

#### 自适应协议

流媒体自适应协议指：视频被编码为多个不同比特率的版本，对应于不同的质量水平；客户可以根据网络状况实时动态的请求不同码率的视频段数据块。  

* LL-HLS（低延迟HLS）  
• 优化：通过部分片段传输、服务端推送等技术将延迟降至2–5秒，兼容现有CDN生态。  

* MPEG-DASH(Dynamic Adaptive Streaming over HTTP，基于HTTP的动态适应性流)  
• 定位：开放替代方案，支持DRM和更多编码格式，广泛用于国际流媒体服务（如Netflix）  

#### 传统协议的新角色  
• RTMP：仍作为推流协议广泛使用（OBS推流至服务器），服务器再转封装为HLS/SRT分发。  
• RTSP：持续用于安防监控（如GB/T28181国标）  

## 内容分发网(Content Distribution Network, CDN)

CDN管理分布在不同地理位置的服务器，这些服务器中存储着视频以及其它类型的web内容副本。  
当收到用户请求时，CDN将请求定向到能提供最好体验的CDN服务器。  

```plantuml
@startmindmap
!include ../resources/mindmap_style.puml
* CDN
** 专用CDN
***_ 内容提供商自己的CDN
** 第三方CDN

* CDN服务器的两种放置原则
** “深入“原则
***:\
部署位置：在遍布全球的ISP接入网中部署CDN，即"深入"到ISP接入网中。
优点：靠近用户，减少了用户和CDN之间的链路和路由器数量，用户低延时和高吞吐量。
缺点：运维复杂，成本高。;
** “邀请做客“原则
***:\
部署位置：在少量关键位置部署大的CDN集群，这个位置通常是IXP(因特网交换点)。相当于是CDN邀请ISP来做客。
优点：较低的维护管理成本。
缺点：用户高延时和低吞吐量。;
@endmindmap
```

并不是每个CDN服务器上都有视频的副本，因为某些视频可能很少观看或者只在某个地区流行。  
CDN采用一种**拉策略**：如果用户向某个cdn服务器请求资源，而这个资源不在当前cdn服务器上，当前cdn从中心仓库或其它cdn拉取资源，拉取的同时在本地缓存副本，类似于Web缓存。  
当某个cdn存储不够时，删除不经常使用的资源。  


CDN系统的工作流程如下：  
1. 当服务器收到用户的请求后，CDN系统**截获**该请求
2. 确定哪个CDN服务器集群更适合用户(**CDN集群选择策略**)
3. 将用户的请求**重定向**到该CDN集群中的某台服务器


### 请求的截获和重定向

大多数CDN系统利用DNS来截获和重定向请求，步骤如下：
1. 本地DNS服务器(LDNS)收到用户的DNS请求后，将该请求最终中继到权威DNS服务器。
2. 权威DNS服务器不直接返回IP，而是返回CDN系统的主机名(第一方CDN或者第三方CDN)给LDNS。***从此刻开始DNS请求进入了CDN系统专用的DNS设施。***
3. LDNS收到CDN系统的主机名后，发送第二个DNS请求，即请求对CDN主机名的解析。
4. CDN系统的DNS服务器使用**CDN集群选择策略**选择一台CDN节点服务器，并将IP地址返回给LDNS。
5. LDNS将CDN节点的IP返给用户。

### CDN集群选择策略 {id="CDN_STRATEGY"}

CDN系统的核心是集群选择策略(cluster selection strategy)，即：CDN系统收到用户的DNS请求后，CDN可以得知用户的LDNS的IP，CDN系统基于该IP选择一个适当的CDN集群或数据中心。

```plantuml
@startmindmap
!include ../resources/mindmap_style.puml
* CDN集群选择策略
** 选择地理上最近的集群
***_ 使用商用的地理位置数据库，每个LDNS的IP对应一个地理位置，CDN系统选择离LDNS最近的集群
***:\
===优点：
  大多数用户可以工作的很好，因为LDNS一般离用户比较近
  
===缺点：
  - 对于网络路近的长度和跳数，地理位置近的集群，网络位置并不一定近
  - 用户可以手动配置距离位置远的LDNS
  - 此策略总是对用户指定相同的集群，忽略了网络时延和带宽的波动;
  
** 实时测量
***_ CDN系统对其集群和用户之间的时延和丢包性能进行周期性的测量。如CDN周期性的对全世界所有的LDNS发送探测报文(ping或者DNS请求)
***:\
===缺点：
  有些LDNS被配置为不响应探测;
@endmindmap
```

### CDN案例 {id="CDN_EXAMPLE"}

#### Netflix

Netflix在IXP和住宅ISP中安装服务器机架。Netflix当前在超过200个IXP位置和数百个ISP位置安装服务器机架。机架中的每台服务器有10Gbps的以太网端口和超过100TB的存储。  
IXP站点通常部署数十台服务器并存储全部Netflix视频库（含支持DASH协议的多版本视频）。

Netflix未采用**拉取式缓存**来更新IXP与ISP中的CDN服务器，而是使用**推缓存**，即在闲时通过推送方式分发视频。  
对于无法存储完整视频库的站点，Netflix仅推送每日更新的热门内容。  
如果当前选择的CDN服务器中没有用户请求的资源，则选择邻近的CDN。  

Netflix不使用**DNS重定向**，当用户请求资源时，Netflix服务端(亚马逊云中)直接告诉客户使用哪一台具体的CDN服务器。  


#### YouTube

谷歌也在几百个IXP和ISP位置安装了服务器集群。  
于Netflix不同，谷歌使用**拉缓存**和**DNS重定向**。  
谷歌的**CDN集群选择策略**是选择客户于集群之间RTT最低的集群。但是有时为了平衡集群的负载，客户也可能被重定向到远的服务器集群。  