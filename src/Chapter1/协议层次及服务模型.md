# 协议层次及服务模型

* 服务(Service)  
低层实体向上层实体提供它们之间的通信的能力；  
底层实体为服务提供者，上层实体为服务用户  
底层实体通过服务访问点(SAP)来区分不同的上层服务用户

```plantuml
@startmindmap
* 服务
** 面向连接的服务
** 无连接的服务
@endmindmap
```

* 原语(primitive)  
上层使用下层服务的具体形式。服务原语即是服务中的不可分割的原子操作，比如应用层（N+1层）通过传输层（N层）的 CONNECT.request 原语请求建立连接

* SAP(Service Access Point，服务访问点)  
 SAP是N层实体向N+1层实体提供服务的逻辑接口，相当于上下层之间的“桥梁”。  
 如传输层给应用层提供的**端口**；网络层给传输层提供的**IP地址**。  

* 协议(protocol)  
对等层实体(peer entity)之间在相互 通信的过程中，需要遵循的规则的集合

* SDU(Service Data Unit, 服务数据单元)  
  由上一层传递到本层还未被处理的数据

* PDU(Protocol Data Unit，协议数据单元)  
将本层SDU经过特定格式处理后将传递到下一层的数据  
第N层PDU = 第N层头部 + 第N层SDU(即第N+1层PDU)

## 协议分层
网络协议以分层的方式来组织。各层的所有协议称为协议栈。

协议层次中，下层给上层提供服务(提供接口)，上层使用下层提供的服务(使用接口)。

```plantuml
@startmindmap
* 一个协议层可以使用软件、硬件或者软硬件结合的方式来实现：
** 如应用层协议HTTP和SMTP是在端系统的软件中实现，传输层协议也是。
** 物理层和数据链路层负责处理特定链路的通信，他们通常在与特定链路关联的网卡中实现(如以太网卡、WiFi接口卡)。
** 网络层协议通常是软硬件结合来实现。
@endmindmap
```

协议分层的缺点：
* 不同层可能有功能冗余。如多个层都有差错恢复。
* 某层的功能可能需要其它层才有的信息(如：时间戳)，这违反了层次分离的目的。

```plantuml
@startmindmap
* 因特网协议栈
** 应用层
*** 应用程序到应用程序
***_ 应用层的PDU称为“报文(message)”
*** 应用层协议分布在多个端系统上，如HTTP、SMTP、FTP、DNS。

** 传输层(运输层)
*** 端口到端口
***_ 传输层PDU：TCP PDU称为“TCP报文段(segment)”，UDP PDU称为”UDP数据报(datagram)“
*** 两种传输层协议
**** TCP
*****_ 面向连接
*****_ 流量控制(发送方和接收方速率匹配)
*****_ 拥塞控制(网络拥塞时，抑制发送方传输速率)
**** UDP
*****_ 无连接
*****_ 无流量控制，无拥塞控制

** 网络层(IP层)
*** 端到端(IP地址到IP地址)
***_ 网络层PDU称“分组(packet)“或“数据报(datagram)”
*** 网络层协议
**** 网际协议(IP)
**** 各种路由交换协议

** 链路层
*** 节点到节点(主机或路由器)
***_ 链路层PDU称为“帧(frame)”
*** 链路层协议(与特定的链路有关)
**** 以太网
**** WiFi
**** 电缆接入网的DOCSIS
**** 点对点协议PPP

** 物理层
***_ 物理层传输的信息单位是bit
*** 物理层协议与实际传输媒介有关
**** 链路层一般是和物理层配套，如以太网有多种物理层协议
*****_ 与双绞铜线有关的
*****_ 与同轴电缆有关的
*****_ 与光纤有关的
@endmindmap
```

## 封装

下层接收上层的分组，并添加附加信息，组成本层的分组，称为封装。

每一层的分组具有两个类型的字段：首部和有效载荷(payload)，有效载荷来自上一层。